\ProvidesExplPackage{magicwatermark}{2024/06/11}{v1.0.1}{magic watermark, author}




\seq_new:N \l__mw_tmpa_seq 
\seq_new:N \l__mw_tmpb_seq 
\seq_new:N \l__mw_tmpc_seq 
\seq_new:N \l__mw_tmpd_seq 


\clist_new:N \l__mw_list_arabic_number_clist 
\clist_new:N \l__mw_list_roman_number_clist 
\clist_new:N \l__mw_list_range_clist 
\clist_new:N \l__mw_list_expression_clist


\tl_const:Nn \c__mw_arabic_numbers_tl { 0123456789 }
\tl_const:Nn \c__mw_roman_numbers_tl { ivxlcdm }


\int_new:N \g__mw_last_page_int 

\AtBeginDocument{
  \int_compare:nTF { \@abspage@last = \number\maxdimen }
  {
    \int_gset:Nn \g__mw_last_page_int { 10 }
  }
  {
    \int_gset:Nn \g__mw_last_page_int { \@abspage@last }
  }
}



\cs_new_nopar:Npn \__mw_list_parser:nN #1#2 {
  % case 1 -> odd, even
  % case 2 -> number, 1
  % case 3 -> roman, i
  % case 4 -> range, 1-5, 3-ii
  % case 5 -> expression, 3X + 1

  % split by commas
  \seq_set_split:Nnn \l__mw_tmpa_seq { , } { #1 }
  \seq_map_inline:Nn \l__mw_tmpa_seq
  {
    \tl_if_eq:nnTF { ##1 } { odd } % odd, push 2X + 1
    {
      \clist_push:Nn \l__mw_list_expression_clist  { 2X + 1 }
    }
    {
      \tl_if_eq:nnTF { ##1 } { even } % even, push 2X
      {
        \clist_push:Nn \l__mw_list_expression_clist  { 2X }
      }
      {
        \tl_if_in:nnTF { ##1 } { X } % expression, push ##1
        {
          \clist_push:Nn \l__mw_list_expression_clist { ##1 }
        }
        {
          \tl_if_in:nnTF { ##1 } { - } % range, push ##1
          {
            \clist_push:Nn \l__mw_list_range_clist { ##1 }
          }
          {
            \tl_if_in:NnTF \c__mw_arabic_numbers_tl { ##1 }
            {
              \clist_push:Nn \l__mw_list_arabic_number_clist { ##1 }
            }
            {
              \tl_if_in:NnTF \c__mw_roman_numbers_tl { ##1 }
              {
                \clist_push:Nn \l__mw_list_roman_number_clist { ##1 }
              }
              {
                % error
                error~para~``##1''
              }
            }
          }
        }
      }
    }
  }
}






\cs_set_nopar:Npn \__mw_range_to_list:nN #1#2 {
  \seq_set_split:Nnn \l__module_tmpa_seq { , } { #1 }
  \seq_map_inline:Nn \l__module_tmpa_seq 
  {
    \tl_if_in:nnTF { ##1 }{ - }
    {
      \seq_set_split:Nnn \l__module_tmpb_seq { - } { ##1 }
      \int_step_inline:nnn 
      { \seq_item:Nn \l__module_tmpb_seq { 1 } } 
      { \seq_item:Nn \l__module_tmpb_seq { 2 } } 
      {
        \clist_put_right:Nn #2 { ####1 }
      }
    }
    {
      \clist_put_right:Nn #2 { ##1 }
    }    
  }
}


